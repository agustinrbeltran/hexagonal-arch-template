services:
  # Your FastAPI Application
  # Note: Supabase services are managed separately via `supabase start`
  # The app connects to Supabase's database running on localhost:54322
  web_app:
    build:
      context: ../..
      dockerfile: config/${APP_ENV}/Dockerfile
    image: web_app:${APP_ENV}
    environment:
      APP_ENV: ${APP_ENV}
      UVICORN_HOST: ${UVICORN_HOST}
      UVICORN_PORT: ${UVICORN_PORT}
      # Connect to Supabase's database (runs on localhost:54322 by default)
      POSTGRES_HOST: host.docker.internal
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-54322}
    ports:
      - "127.0.0.1:${UVICORN_PORT}:${UVICORN_PORT}"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: >
      sh -c "
      echo 'Starting Uvicorn...' &&
      uvicorn src.run:make_app --factory --host ${UVICORN_HOST} --port ${UVICORN_PORT} --loop uvloop
      "
